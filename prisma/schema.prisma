generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("POSTGRES_URL_NON_POOLING")
}

enum RegionCode {
  NA
  EU
  SA
  AS
  OC
}

// Notifications
enum NotificationType {
  TEAM_INVITE
  TEAM_JOIN_REQUEST
  TEAM_REQUEST_ACCEPTED
  TEAM_REQUEST_REJECTED
  SCRIM_REQUEST_RECEIVED
  SCRIM_REQUEST_ACCEPTED
  SCRIM_REQUEST_REJECTED
  GENERIC
}

model User {
  id           Int      @id @default(autoincrement())
  username     String   @unique
  email        String   @unique
  passwordHash String
  phoneNumber  String?
  dob          DateTime
  createdAt    DateTime @default(now())

  region       RegionCode?
  profilePhoto String?

  // Relations
  profiles            UserGameProfile[]
  memberships         TeamMembership[]
  teamRequestsAsUser  TeamRequest[]     @relation("TeamRequestUser")
  teamRequestsCreated TeamRequest[]     @relation("TeamRequestCreatedBy")
  scrimRequests       ScrimRequest[]    @relation("ScrimRequestRequestedBy")
  notifications       Notification[]
}

model Game {
  id        Int    @id @default(autoincrement())
  name      String
  shortCode String @unique

  // Relations
  profiles UserGameProfile[]
  teams    Team[]
  ranks    GameRank[]
}

model GameRank {
  id    Int    @id @default(autoincrement())
  name  String
  order Int

  iconUrl String?

  // FKs
  gameId Int

  // Relations
  game     Game              @relation(fields: [gameId], references: [id])
  profiles UserGameProfile[]
  teams    Team[]

  @@unique([gameId, name])
  @@index([gameId])
}

model UserGameProfile {
  id         Int    @id @default(autoincrement())
  ingameName String
  wins       Int    @default(0)
  losses     Int    @default(0)

  lookingForTeam Boolean @default(false)

  // FKs
  userId Int
  gameId Int
  rankId Int?

  // Relations
  user User      @relation(fields: [userId], references: [id])
  game Game      @relation(fields: [gameId], references: [id])
  rank GameRank? @relation(fields: [rankId], references: [id])

  @@unique([userId, gameId], name: "user_game_unique")
  @@index([userId])
  @@index([gameId])
  @@index([rankId])
}

model Team {
  id        Int        @id @default(autoincrement())
  name      String
  slug      String     @unique
  region    RegionCode
  logoUrl   String?
  bio       String?
  createdAt DateTime   @default(now())

  isRecruiting Boolean @default(false)

  // FKs
  gameId Int
  rankId Int?

  // Relations
  game          Game             @relation(fields: [gameId], references: [id])
  rank          GameRank?        @relation(fields: [rankId], references: [id])
  memberships   TeamMembership[]
  requests      TeamRequest[]
  hostedScrims  Scrim[]
  scrimRequests ScrimRequest[]
  notifications Notification[]

  @@index([gameId])
  @@index([rankId])
}

model TeamMembership {
  id       Int      @id @default(autoincrement())
  role     String
  joinedAt DateTime @default(now())

  // FKs
  userId Int
  teamId Int

  // Relations
  user User @relation(fields: [userId], references: [id])
  team Team @relation(fields: [teamId], references: [id])

  @@unique([userId, teamId], name: "user_team_unique")
  @@index([userId])
  @@index([teamId])
}

model TeamRequest {
  id          Int       @id @default(autoincrement())
  kind        String // e.g. "invite" or "join_request"
  status      String // e.g. "pending", "accepted", "rejected"
  createdAt   DateTime  @default(now())
  respondedAt DateTime?

  // FKs
  teamId          Int
  userId          Int
  createdByUserId Int

  // Relations
  team          Team           @relation(fields: [teamId], references: [id])
  user          User           @relation("TeamRequestUser", fields: [userId], references: [id])
  createdBy     User           @relation("TeamRequestCreatedBy", fields: [createdByUserId], references: [id])
  notifications Notification[]

  @@index([teamId])
  @@index([userId])
  @@index([createdByUserId])
}

model Scrim {
  id          Int       @id @default(autoincrement())
  bestOf      Int
  gamemode    String
  map         String
  scrimCode   String
  scheduledAt DateTime?
  status      String
  createdAt   DateTime  @default(now())

  // FKs
  hostTeamId Int

  // Relations
  hostTeam      Team           @relation(fields: [hostTeamId], references: [id])
  requests      ScrimRequest[]
  notifications Notification[]

  @@unique([scrimCode])
  @@index([hostTeamId])
}

model ScrimRequest {
  id          Int       @id @default(autoincrement())
  status      String
  requestedAt DateTime  @default(now())
  respondedAt DateTime?
  codeSent    Boolean   @default(false)

  // FKs
  scrimId           Int
  teamId            Int
  requestedByUserId Int

  // Relations
  scrim         Scrim          @relation(fields: [scrimId], references: [id])
  team          Team           @relation(fields: [teamId], references: [id])
  requestedBy   User           @relation("ScrimRequestRequestedBy", fields: [requestedByUserId], references: [id])
  notifications Notification[]

  @@index([scrimId])
  @@index([teamId])
  @@index([requestedByUserId])
}

// Notifications model
model Notification {
  id          Int              @id @default(autoincrement())
  recipientId Int
  type        NotificationType

  title     String
  body      String
  createdAt DateTime  @default(now())
  readAt    DateTime? // null = unread

  teamId         Int?
  teamRequestId  Int?
  scrimId        Int?
  scrimRequestId Int?

  metadata Json?

  // Relations
  recipient    User          @relation(fields: [recipientId], references: [id])
  team         Team?         @relation(fields: [teamId], references: [id], onDelete: SetNull)
  teamRequest  TeamRequest?  @relation(fields: [teamRequestId], references: [id], onDelete: SetNull)
  scrim        Scrim?        @relation(fields: [scrimId], references: [id], onDelete: SetNull)
  scrimRequest ScrimRequest? @relation(fields: [scrimRequestId], references: [id], onDelete: SetNull)

  @@index([recipientId, readAt, createdAt])
}
